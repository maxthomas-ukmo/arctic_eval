# ESMValTool
# recipe_arctic_ocean.yml
---
documentation:
  title: Arctic Ocean Diagnostics
  description: |
    Arctic Ocean diagnostics.

  authors:
    - koldunov_nikolay

  maintainer:
    - koldunov_nikolay

  references:
    - contact_authors

  projects:
    - trr181
    - applicate

# Model problems
datasets:
  - {dataset: HadGEM3-GC31-LL, project: CMIP6}
  - {dataset: HadGEM3-GC31-MM, project: CMIP6}

preprocessors:

# Extract the whole Arctic region
# This preprocessor is recycled using the anchor
  extract_whole_arctic: &extract_whole_arctic_preprocessor
    extract_region: 
      start_longitude: 0
      end_longitude: 360
      start_latitude: 50
      end_latitude: 90

 # Mean of each month for the whole Arctic (i.e. a seasonal cycle)
 # Data are returned on the native grid (no area processing) and min/mean/max are calculated for individual model ensembles
  arctic_gs_monthmean:
    # extract Arctic
    <<: *extract_whole_arctic_preprocessor 
    climate_statistics: # calculate montly means
      operator: mean
      period: month
    multi_model_statistics: # calculate ensemble statistics
      span: full
      statistics: [mean, min, max]
      groupby: [dataset] # this is needed to get an ensemble of a single model

# TODO: Think about using the extract preprocessor anchor here
# This preprocessor is used to extract the 2D (lat/lon) maps
  2D_map:
    extract_region:
      start_longitude: 0
      end_longitude: 360
      start_latitude: 0
      end_latitude: 90
    multi_model_statistics:
      span: full
      statistics: [mean]
      groupby: [dataset]

# This preprocessor is used to calculate the time series
# Data are returned on the native grid (no area processing) and mean is calculated for individual model ensembles
  timeseries_gs:
    <<: *extract_whole_arctic_preprocessor
    multi_model_statistics:
      span: full
      statistics: [mean]
      groupby: [dataset]
      
    
diagnostics:

#=====================================================================
# Seasonal cycle
# Gridded, monthly climatology data for model ensembles is passed to the diagnostics.
# PIOMAS and HadISST are available for comparison.
#=====================================================================
  seasonal_cycle:
    description: Seasonal cycles
    variables:
      sivol: &seasonalcycle_var
        mip: SImon
        exp: historical
        ensemble: r*i1p1f3
        grid: gn
        start_year: 1979
        end_year: 2001
        preprocessor: arctic_gs_monthmean
      siconc: 
        <<: *seasonalcycle_var
        mip: SImon
        exp: historical
        ensemble: r*i1p1f3
        grid: gn
        start_year: 1979
        end_year: 2001
        preprocessor: arctic_gs_monthmean
        additional_datasets:
          -  {dataset: HadISST, project: OBS, mip: OImon, tier: 2, type: reanaly, version: 1, ensemble: '', grid: '', alias: OBS_HadISST}
      areacello:
        mip: Ofx
        grid: gn
        exp: piControl
        ensemble: r1i1p1f1
        preprocessor: extract_whole_arctic
        additional_datasets:
          - {dataset: PIOMAS, project: OBS, mip: fx, tier: 2, type: reanaly, version: 2.1, ensemble: '', grid: '', alias: OBS_PIOMAS}
      sithick:
        <<: *seasonalcycle_var
        additional_datasets:
          - {dataset: PIOMAS, project: OBS, mip: day, tier: 2, type: reanaly, version: 2.1, ensemble: '', grid: '', alias: OBS_PIOMAS}
      sisnthick:
        <<: *seasonalcycle_var
    scripts:
      seasonal_cycle:
        script: ~/arctic_eval/code/diag_scripts/arctic_eval.py
        dummy_plot: False
        variables_to_plot: [siconc, sivol, sisnthick]
        model_datasets: [HadGEM3-GC31-LL, HadGEM3-GC31-MM]
        regions: ['Arctic', 'EB', 'AB']
        obs_datasets: 
          siconc: HadISST
          sivol: PIOMAS
        variables_to_plot_obs: [siconc, sivol]
#=====================================================================

#======================================================================
# Maps
#======================================================================
  maps:
    description: Maps of March and September sea-ice concentration
    variables:
      sisnthick: &maps_var
        mip: SImon
        exp: historical
        ensemble: r*i1p1f3
        grid: gn
        start_year: 1979
        end_year: 2001
        preprocessor: 2D_map # this excludes the sum
      siconc: 
        <<: *maps_var
        additional_datasets:
          -  {dataset: HadISST, project: OBS, mip: OImon, tier: 2, type: reanaly, version: 1, ensemble: '', grid: ''}
      sithick: 
        <<: *maps_var
        additional_datasets:
          - {dataset: PIOMAS, project: OBS, mip: day, tier: 2, type: reanaly, version: 2.1, ensemble: '', grid: ''}
      sisnthick:
        <<: *maps_var
    scripts:
      geo_map_march_sept:
        script: ~/arctic_eval/code/diag_scripts/arctic_eval.py
        dummy_plot: False
        variables_to_plot: [siconc, sithick, sisnthick]
        regions: ['Arctic']
        model_datasets: [HadGEM3-GC31-LL, HadGEM3-GC31-MM]
        obs_datasets: 
          siconc: HadISST
          sithick: PIOMAS
        cbar_ranges:
          siconc: [0, 100]
          sithick: [0, 7]
        variables_to_plot_obs: [siconc, sithick]
        months: [3, 9]   
#======================================================================

#======================================================================
# Time series
#======================================================================
  timeseries:
    description: Time series of integrated variables
    variables:
      sisnthick: &timeseries_var
        mip: SImon
        exp: historical
        ensemble: r*i1p1f3
        grid: gn
        start_year: 1979
        end_year: 2014
        preprocessor: timeseries_gs 
      siconc: 
        <<: *timeseries_var
        additional_datasets:
          -  {dataset: HadISST, project: OBS, mip: OImon, tier: 2, type: reanaly, version: 1, ensemble: '', grid: ''}
      areacello:
        mip: Ofx
        grid: gn
        exp: piControl
        ensemble: r1i1p1f1
        preprocessor: extract_whole_arctic
        additional_datasets:
          - {dataset: PIOMAS, project: OBS, mip: fx, tier: 2, type: reanaly, version: 2.1, ensemble: '', grid: '', alias: OBS_PIOMAS}
      sithick: 
        <<: *timeseries_var
        additional_datasets:
          - {dataset: PIOMAS, project: OBS, mip: day, tier: 2, type: reanaly, version: 2.1, ensemble: '', grid: '', alias: OBS_PIOMAS}
    scripts:
      timeseries:
        script: ~/arctic_eval/code/diag_scripts/arctic_eval.py
        dummy_plot: False
        variables_to_plot: [siconc, sithick, sisnthick]
        model_datasets: [HadGEM3-GC31-LL, HadGEM3-GC31-MM]
        obs_datasets: 
          siconc: HadISST
          sithick: PIOMAS
        variables_to_plot_obs: [siconc, sithick]
        regions: ['Arctic', 'EB', 'AB']
        running_mean_window: 12
#======================================================================

#======================================================================
# Region plot
#======================================================================
  region_plot:
    description: Regions used for subsetting
    variables:
      siconc: &region_plot_var
        mip: SImon
        exp: historical
        ensemble: r*i1p1f3
        grid: gn
        start_year: 1979
        end_year: 1980
        preprocessor: 2D_map 
        additional_datasets:
          -  {dataset: HadISST, project: OBS, mip: OImon, tier: 2, type: reanaly, version: 1, ensemble: '', grid: '', alias: OBS_HadISST}
      areacello:
        mip: Ofx
        grid: gn
        exp: piControl
        ensemble: r1i1p1f1
        preprocessor: extract_whole_arctic
        additional_datasets:
          - {dataset: PIOMAS, project: OBS, mip: fx, tier: 2, type: reanaly, version: 2.1, ensemble: '', grid: '', alias: OBS_PIOMAS}
    scripts:
      regions:
        script: ~/arctic_eval/code/diag_scripts/arctic_eval.py
        dummy_plot: False
        masks_to_derive: [HadGEM3-GC31-LL, HadGEM3-GC31-MM, HadISST, PIOMAS]
        regions: ['EB', 'AB', 'Barents_sea']
        region_centers: [[85,0], [85, 180], [75, 40]]
        derive_mask_from:
          HadGEM3-GC31-LL: siconc
          HadGEM3-GC31-MM: siconc
          HadISST: siconc
          PIOMAS: areacello
#======================================================================
